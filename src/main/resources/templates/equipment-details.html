<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${equipment.name} + ' - EquipTrack'">Equipment Details - EquipTrack</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Use navbar fragment -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <section class="browse-section">
        <div class="container">
            <a href="/browse-equipment" style="color: var(--gray-600); text-decoration: none; display: inline-block; margin-bottom: 2rem;">
                ‚Üê Back to Equipment
            </a>

            <div class="booking-container">
                <div class="booking-form-section">
                    <div class="equipment-image" style="height: 400px; border-radius: 12px; margin-bottom: 2rem;" 
                         th:style="'height: 400px; border-radius: 12px; margin-bottom: 2rem; background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-200) 100%); border: 3px solid var(--primary-color);'">
                        <span class="equipment-initial" th:text="${equipment.name.substring(0, 1)}">E</span>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                        <div>
                            <h1 th:text="${equipment.name}" style="font-size: 2.5rem; font-weight: 800; color: var(--dark); margin-bottom: 0.5rem;">Equipment Name</h1>
                            <p th:text="${equipment.description}" style="color: var(--gray-600); font-size: 1.125rem;">Description</p>
                        </div>
                        <span class="status-badge" 
                              th:classappend="${equipment.status == T(com.equiptrack.model.Equipment.EquipmentStatus).AVAILABLE ? 'available' : 'unavailable'}"
                              th:text="${equipment.status}"
                              style="font-size: 1rem; padding: 0.5rem 1rem;">AVAILABLE</span>
                    </div>

                    <div class="equipment-details" style="background: var(--gray-50); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--dark);">Details</h3>
                        <div class="detail-item">
                            <span class="detail-label">üí∞ Daily Rate</span>
                            <span class="detail-value" th:text="'‚Çπ' + ${equipment.dailyRate} + '/day'">‚Çπ10200/day</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üìç Location</span>
                            <span class="detail-value" th:text="${location?.name ?: 'N/A'}">Warehouse A</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üì¶ Category</span>
                            <span class="detail-value" th:text="${category?.name ?: 'N/A'}">Heavy Machinery</span>
                        </div>
                        <div class="detail-item" th:if="${equipment.manufacturer}">
                            <span class="detail-label">üè≠ Manufacturer</span>
                            <span class="detail-value" th:text="${equipment.manufacturer}">CAT</span>
                        </div>
                        <div class="detail-item" th:if="${equipment.model}">
                            <span class="detail-label">üîß Model</span>
                            <span class="detail-value" th:text="${equipment.model}">320</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üìÖ Availability</span>
                            <span class="detail-value" th:text="${availabilityMessage}">Available now</span>
                        </div>
                    </div>

                    <!-- Admin cannot book equipment -->
                    <div sec:authorize="hasRole('ADMIN')" style="padding: 2rem; background: var(--black); border-radius: 12px; text-align: center; color: var(--primary-color); border: 3px solid var(--primary-color);">
                        <svg width="64" height="64" viewBox="0 0 64 64" fill="none" style="margin-bottom: 1rem;">
                            <circle cx="32" cy="32" r="30" fill="rgba(255,255,255,0.2)"/>
                            <path d="M32 20V34M32 42V44" stroke="white" stroke-width="4" stroke-linecap="round"/>
                        </svg>
                        <h3 style="margin-bottom: 0.5rem; color: white;">Administrator Access</h3>
                        <p style="font-size: 1rem; opacity: 0.9;">Only customers can book equipment. As an admin, you can view all bookings and manage equipment in the Admin Dashboard.</p>
                    </div>

                    <!-- Customer booking form -->
                    <form id="bookingForm" sec:authorize="hasRole('CUSTOMER')">
                        <h3 style="margin-bottom: 1.5rem; color: var(--dark);">Book This Equipment</h3>
                        
                        <div class="date-picker">
                            <div class="form-group">
                                <label for="startDate">Start Date</label>
                                <input type="date" id="startDate" name="startDate" required>
                            </div>
                            <div class="form-group">
                                <label for="endDate">End Date</label>
                                <input type="date" id="endDate" name="endDate" required>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 1rem;">
                            <label for="notes">Special Requirements (Optional)</label>
                            <textarea id="notes" name="notes" rows="4" style="padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px; width: 100%; font-family: inherit;"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary btn-full" style="margin-top: 1.5rem;">
                            Book Now
                        </button>
                    </form>

                    <!-- Guest must login -->
                    <div sec:authorize="!isAuthenticated()" style="padding: 2rem; background: var(--gray-50); border-radius: 12px; text-align: center;">
                        <h3 style="margin-bottom: 0.5rem; color: var(--dark);">Login Required</h3>
                        <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Please log in to book this equipment.</p>
                        <a href="/login" class="btn btn-primary">Login</a>
                    </div>
                </div>

                <div class="booking-summary">
                    <h3 style="margin-bottom: 1.5rem; color: var(--dark);">Booking Summary</h3>
                    
                    <div class="summary-item">
                        <span>Daily Rate:</span>
                        <span th:text="'‚Çπ' + ${equipment.dailyRate}">‚Çπ10200</span>
                    </div>
                    <div class="summary-item">
                        <span>Number of Days:</span>
                        <span id="numberOfDays">-</span>
                    </div>
                    <div class="summary-item">
                        <span>Subtotal:</span>
                        <span id="subtotal">‚Çπ0</span>
                    </div>
                    <div class="summary-item">
                        <span>Tax (5%):</span>
                        <span id="tax">‚Çπ0</span>
                    </div>
                    <div class="summary-item summary-total">
                        <span>Total:</span>
                        <span id="total">‚Çπ0</span>
                    </div>

                    <div style="margin-top: 2rem; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                        <p style="font-size: 0.875rem; color: var(--gray-600);">
                            ‚úì Free cancellation up to 24 hours before pickup<br>
                            ‚úì Insurance included<br>
                            ‚úì 24/7 customer support
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 EquipTrack. All rights reserved.</p>
        </div>
    </footer>

    <script th:inline="javascript">
        const dailyRate = /*[[${equipment.dailyRate}]]*/ 450;
        const equipmentId = /*[[${equipment.id}]]*/ 1;

        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        startDateInput.min = today;
        endDateInput.min = today;

        function calculateTotal() {
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);

            if (startDate && endDate && endDate >= startDate) {
                const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                const subtotal = dailyRate * days;
                const tax = subtotal * 0.05;
                const total = subtotal + tax;

                document.getElementById('numberOfDays').textContent = days;
                document.getElementById('subtotal').textContent = '‚Çπ' + subtotal.toFixed(2);
                document.getElementById('tax').textContent = '‚Çπ' + tax.toFixed(2);
                document.getElementById('total').textContent = '‚Çπ' + total.toFixed(2);
            }
        }

        startDateInput.addEventListener('change', calculateTotal);
        endDateInput.addEventListener('change', () => {
            endDateInput.min = startDateInput.value;
            calculateTotal();
        });

        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const bookingData = {
                equipmentId: equipmentId,
                startDate: startDateInput.value,
                endDate: endDateInput.value,
                customerNotes: document.getElementById('notes').value
            };

            console.log('Sending booking data:', bookingData);

            try {
                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(bookingData)
                });

                if (response.ok) {
                    const booking = await response.json();
                    // Redirect to payment page
                    window.location.href = '/payment?bookingId=' + booking.id;
                } else {
                    const error = await response.text();
                    alert('Error creating booking: ' + (error || 'Please try again.'));
                }
            } catch (error) {
                console.error('Booking error:', error);
                alert('An error occurred. Please try again.');
            }
        });
    </script>
</body>
</html>
